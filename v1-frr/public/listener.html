<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéß Listener</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      width: 100%;
    }

    .player-card {
      background: white;
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .player-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 30px 30px 0 0;
      z-index: 0;
    }

    .header {
      position: relative;
      z-index: 1;
      color: white;
      text-align: center;
      margin-bottom: 30px;
    }

    .room-badge {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 5px;
    }

    .header .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .content {
      position: relative;
      z-index: 1;
    }

    /* Album Art */
    .album-art {
      width: 200px;
      height: 200px;
      margin: 0 auto 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
    }

    .album-art::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .album-art.playing::before {
      opacity: 1;
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }

    /* Track Info */
    .track-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .track-title {
      font-size: 24px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .track-artist {
      font-size: 18px;
      color: #6b7280;
    }

    /* Status */
    .status {
      background: #f9fafb;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 25px;
    }

    .status-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .status-text {
      font-size: 16px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .status-subtext {
      font-size: 13px;
      color: #6b7280;
    }

    /* Enable Audio Button */
    .enable-audio-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 25px;
      animation: pulse 2s ease-in-out infinite;
    }

    .enable-audio-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* Wave Visualizer */
    .wave-visualizer {
      display: none;
      justify-content: center;
      align-items: center;
      height: 80px;
      margin-bottom: 25px;
      gap: 6px;
    }

    .wave-visualizer.active {
      display: flex;
    }

    .wave-bar {
      width: 8px;
      height: 20px;
      background: linear-gradient(to top, #667eea, #764ba2);
      border-radius: 4px;
      animation: wave 1s ease-in-out infinite;
    }

    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { animation-delay: 0.3s; }
    .wave-bar:nth-child(7) { animation-delay: 0.2s; }
    .wave-bar:nth-child(8) { animation-delay: 0.1s; }

    @keyframes wave {
      0%, 100% { height: 20px; opacity: 0.5; }
      50% { height: 60px; opacity: 1; }
    }

    /* Latency Display */
    .latency-display {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 25px;
      display: none;
    }

    .latency-display.active {
      display: block;
    }

    .latency-label {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .latency-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .latency-quality {
      font-size: 12px;
      opacity: 0.9;
    }

    .latency-display.high {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .latency-display.critical {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    /* Volume Control */
    .volume-control {
      background: #f9fafb;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      display: none;
    }

    .volume-control.active {
      display: block;
    }

    .volume-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      color: #374151;
      font-weight: 600;
    }

    .volume-slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #e5e7eb;
      outline: none;
      -webkit-appearance: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Info Cards */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 25px;
    }

    .info-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .info-card .icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .info-card .value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .info-card .label {
      font-size: 12px;
      color: #6b7280;
    }

    /* Leave Button */
    .leave-btn {
      width: 100%;
      padding: 15px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      color: #6b7280;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .leave-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
      transform: scale(1.02);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(102, 126, 234, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 20px;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .player-card {
        padding: 30px 20px;
      }

      .album-art {
        width: 160px;
        height: 160px;
        font-size: 60px;
      }

      .track-title {
        font-size: 20px;
      }

      .track-artist {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Joining room...</div>
    </div>
  </div>

  <div class="container">
    <div class="player-card">
      <!-- Header -->
      <div class="header">
        <div class="room-badge">Room: <strong id="roomCode">----</strong></div>
        <h1>üéß Listening Mode</h1>
        <p class="subtitle">Host: <span id="hostName">Loading...</span></p>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Album Art -->
        <div class="album-art" id="albumArt">üéµ</div>

        <!-- Track Info -->
        <div class="track-info">
          <div class="track-title" id="trackTitle">No Track Playing</div>
          <div class="track-artist" id="trackArtist">Waiting for host...</div>
        </div>

        <!-- Status -->
        <div class="status" id="status">
          <div class="status-icon">üîä</div>
          <div class="status-text">Ready to Listen</div>
          <div class="status-subtext">Click the button below to enable audio</div>
        </div>

        <!-- Enable Audio Button -->
        <button class="enable-audio-btn" id="enableAudioBtn" onclick="enableAudio()">
          üîä CLICK TO ENABLE AUDIO
        </button>

        <!-- Wave Visualizer -->
        <div class="wave-visualizer" id="waveVisualizer">
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>

        <!-- Latency Display -->
        <div class="latency-display" id="latencyDisplay">
          <div class="latency-label">Network Latency</div>
          <div class="latency-value" id="latencyValue">--</div>
          <div class="latency-quality" id="latencyQuality">Measuring...</div>
        </div>

        <!-- Volume Control -->
        <div class="volume-control" id="volumeControl">
          <div class="volume-label">
            <span>üîä Local Volume</span>
            <span id="volumeValue">100%</span>
          </div>
          <input type="range" class="volume-slider" min="0" max="100" value="100" id="volumeSlider" oninput="setVolume(this.value)">
        </div>

        <!-- Info Cards -->
        <div class="info-grid" id="infoGrid" style="display: none;">
          <div class="info-card">
            <div class="icon">‚ö°</div>
            <div class="value" id="bufferHealth">--</div>
            <div class="label">Buffer Health</div>
          </div>
          <div class="info-card">
            <div class="icon">üìä</div>
            <div class="value" id="audioQuality">--</div>
            <div class="label">Quality</div>
          </div>
        </div>

        <!-- Leave Button -->
        <button class="leave-btn" onclick="leaveRoom()">üö™ Leave Room</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let roomCode = '';
    let listenerName = '';
    let audioContext;
    let gainNode;
    let audioQueue = [];
    let isPlaying = false;
    let scheduledTime = 0;
    let audioEnabled = false;
    let latencyHistory = [];
    let pingInterval;
    let lastChunkTime = 0;
    let currentSampleRate = 44100;
    let currentChannels = 1;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('room');
    listenerName = urlParams.get('name') || 'Listener';

    if (!roomCode) {
      alert('No room code provided');
      window.location.href = '/';
    }

    document.getElementById('roomCode').textContent = roomCode;

    socket.on('connect', () => {
      console.log('‚úÖ Connected to server');
      
      socket.emit('join-as-listener', { roomCode, listenerName }, (response) => {
        if (response.error) {
          console.error('‚ùå Error:', response.error);
          alert('Room not found. Redirecting...');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
          return;
        }

        console.log('‚úÖ Joined room:', roomCode);

        document.getElementById('hostName').textContent = response.hostName;
        
        if (response.currentState) {
          updateState(response.currentState);
        }

        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ENABLE AUDIO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function enableAudio() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext({ sampleRate: 44100 });
      
      gainNode = audioContext.createGain();
      gainNode.connect(audioContext.destination);
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }

      audioEnabled = true;
      
      document.getElementById('enableAudioBtn').style.display = 'none';
      document.getElementById('latencyDisplay').classList.add('active');
      document.getElementById('volumeControl').classList.add('active');
      document.getElementById('infoGrid').style.display = 'grid';
      
      document.getElementById('status').innerHTML = `
        <div class="status-icon">‚úÖ</div>
        <div class="status-text">Audio Enabled</div>
        <div class="status-subtext">Waiting for stream...</div>
      `;

      console.log('‚úÖ Audio enabled');
      console.log('   Initial sample rate:', audioContext.sampleRate);

      startPingMonitoring();
      startPlaybackScheduler();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STREAM CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    socket.on('stream-config', ({ sampleRate, channels, chunkDuration, quality }) => {
      if (!audioEnabled) return;

      console.log('üîß Stream config:', sampleRate, 'Hz,', channels, 'ch,', chunkDuration, 'ms chunks');
      
      currentSampleRate = sampleRate;
      currentChannels = channels;
      
      // Recreate AudioContext if sample rate changed significantly
      if (audioContext && Math.abs(audioContext.sampleRate - sampleRate) > 1000) {
        console.log('üîÑ Recreating AudioContext for', sampleRate, 'Hz');
        
        const currentVolume = gainNode.gain.value;
        
        audioContext.close();
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext({ sampleRate: sampleRate });
        
        gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
        gainNode.connect(audioContext.destination);
        
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        // Reset playback state
        audioQueue = [];
        isPlaying = false;
        scheduledTime = 0;
        
        console.log('‚úÖ AudioContext recreated:', audioContext.sampleRate, 'Hz');
      }
      
      // Update quality display
      const qualityMap = {
        'low': '22kHz',
        'standard': '44kHz',
        'high': '48kHz'
      };
      document.getElementById('audioQuality').textContent = qualityMap[quality] || sampleRate/1000 + 'kHz';
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUDIO PLAYBACK (STABLE - NO CRACKLING)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    socket.on('audio-chunk', (payload) => {
      if (!audioContext || !audioEnabled) return;

      const receiveTime = performance.now();
      
      if (lastChunkTime > 0) {
        const timeSinceLastChunk = receiveTime - lastChunkTime;
        latencyHistory.push(timeSinceLastChunk);
        if (latencyHistory.length > 20) latencyHistory.shift();
      }
      lastChunkTime = receiveTime;

      try {
        const arrayBuffer = payload.data || payload;
        const chunkSampleRate = payload.sampleRate || currentSampleRate;
        
        const int16 = new Int16Array(arrayBuffer);
        const float32 = new Float32Array(int16.length);
        
        // Convert PCM to float
        for (let i = 0; i < int16.length; i++) {
          float32[i] = int16[i] / 32768.0;
        }
        
        audioQueue.push({ data: float32, sampleRate: chunkSampleRate });
        
        document.getElementById('bufferHealth').textContent = audioQueue.length;
        
        // STABLE: Wait for larger buffer before starting (8-10 chunks)
        if (!isPlaying && audioQueue.length >= 8) {
          console.log('üéµ Starting playback (buffer:', audioQueue.length, 'chunks @', chunkSampleRate, 'Hz)');
          startPlayback();
        }
        
      } catch (err) {
        console.error('‚ùå Audio error:', err);
      }
    });

    function startPlayback() {
      if (isPlaying) return;
      
      isPlaying = true;
      scheduledTime = audioContext.currentTime + 0.15; // Larger initial buffer
      
      document.getElementById('albumArt').classList.add('playing');
      document.getElementById('waveVisualizer').classList.add('active');
      
      document.getElementById('status').innerHTML = `
        <div class="status-icon">üî¥</div>
        <div class="status-text">Now Playing</div>
        <div class="status-subtext">Crystal clear audio streaming</div>
      `;
      
      scheduleNextChunk();
    }

    function scheduleNextChunk() {
      if (!isPlaying) return;
      
      // Schedule ahead smoothly (keep 0.5s scheduled)
      while (audioQueue.length > 0 && scheduledTime < audioContext.currentTime + 0.5) {
        const audioData = audioQueue.shift();
        const float32Data = audioData.data;
        const chunkSampleRate = audioData.sampleRate || currentSampleRate;
        
        // Create buffer with the correct sample rate
        const buffer = audioContext.createBuffer(1, float32Data.length, chunkSampleRate);
        buffer.getChannelData(0).set(float32Data);
        
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(gainNode);
        
        if (scheduledTime < audioContext.currentTime) {
          scheduledTime = audioContext.currentTime;
        }
        
        source.start(scheduledTime);
        scheduledTime += buffer.duration;
      }
      
      // Check every 30ms for smooth scheduling
      setTimeout(() => scheduleNextChunk(), 30);
    }

    function startPlaybackScheduler() {
      setInterval(() => {
        if (isPlaying && audioQueue.length > 0) {
          scheduleNextChunk();
        }
        
        // Warn if buffer is low (below 3 chunks)
        if (audioEnabled && isPlaying && audioQueue.length < 3) {
          console.warn('‚ö†Ô∏è Buffer low:', audioQueue.length);
        }
        
        // Update buffer health color
        const bufferElement = document.getElementById('bufferHealth');
        if (audioQueue.length < 3) {
          bufferElement.style.color = '#ef4444';
        } else if (audioQueue.length < 5) {
          bufferElement.style.color = '#f59e0b';
        } else {
          bufferElement.style.color = '#10b981';
        }
      }, 50);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PING MONITORING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function startPingMonitoring() {
      let pingStart;
      
      pingInterval = setInterval(() => {
        pingStart = Date.now();
        socket.emit('ping-request');
      }, 2000);

      socket.on('pong-response', () => {
        const ping = Date.now() - pingStart;
        
        let avgLatency = ping;
        if (latencyHistory.length > 0) {
          const avgChunkTime = latencyHistory.reduce((a, b) => a + b, 0) / latencyHistory.length;
          avgLatency = Math.round(ping + avgChunkTime / 2);
        }
        
        document.getElementById('latencyValue').textContent = avgLatency + 'ms';
        
        const latencyDisplay = document.getElementById('latencyDisplay');
        const latencyQuality = document.getElementById('latencyQuality');
        
        if (avgLatency < 100) {
          latencyDisplay.className = 'latency-display active';
          latencyQuality.textContent = 'üü¢ Excellent (Ultra-Low)';
        } else if (avgLatency < 200) {
          latencyDisplay.className = 'latency-display active high';
          latencyQuality.textContent = 'üü° Good';
        } else {
          latencyDisplay.className = 'latency-display active critical';
          latencyQuality.textContent = 'üî¥ High Latency';
        }
        
        socket.emit('update-ping', { roomCode, ping: avgLatency });
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VOLUME CONTROL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setVolume(value) {
      document.getElementById('volumeValue').textContent = value + '%';
      if (gainNode) {
        gainNode.gain.setValueAtTime(value / 100, audioContext.currentTime);
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ROOM STATE UPDATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    socket.on('room-state', (state) => {
      updateState(state);
    });

    socket.on('volume-update', ({ volume }) => {
      setVolume(volume * 100);
      document.getElementById('volumeSlider').value = volume * 100;
    });

    socket.on('mute-update', ({ muted }) => {
      if (muted) {
        if (gainNode) gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        document.getElementById('status').innerHTML = `
          <div class="status-icon">üîá</div>
          <div class="status-text">Muted by Host</div>
          <div class="status-subtext">Host has muted your audio</div>
        `;
      } else {
        const volume = document.getElementById('volumeSlider').value / 100;
        if (gainNode) gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
      }
    });

    function updateState(state) {
      if (state.metadata) {
        document.getElementById('trackTitle').textContent = state.metadata.title;
        document.getElementById('trackArtist').textContent = state.metadata.artist;
      }
      
      if (state.quality) {
        const qualityMap = {
          'low': '22kHz',
          'standard': '44kHz',
          'high': '48kHz'
        };
        document.getElementById('audioQuality').textContent = qualityMap[state.quality] || '--';
      }
      
      if (!state.playing && isPlaying) {
        isPlaying = false;
        audioQueue = [];
        scheduledTime = 0;
        
        document.getElementById('albumArt').classList.remove('playing');
        document.getElementById('waveVisualizer').classList.remove('active');
        
        if (audioEnabled) {
          document.getElementById('status').innerHTML = `
            <div class="status-icon">‚è∏Ô∏è</div>
            <div class="status-text">Stream Paused</div>
            <div class="status-subtext">Waiting for host...</div>
          `;
        }
      }
    }

    socket.on('room-closed', () => {
      alert('Room has been closed by host');
      window.location.href = '/';
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LEAVE ROOM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function leaveRoom() {
      if (confirm('Are you sure you want to leave this room?')) {
        if (pingInterval) clearInterval(pingInterval);
        if (audioContext) audioContext.close();
        window.location.href = '/';
      }
    }

    socket.on('disconnect', () => {
      console.log('‚ùå Disconnected');
      isPlaying = false;
      audioQueue = [];
      
      document.getElementById('status').innerHTML = `
        <div class="status-icon">‚ö†Ô∏è</div>
        <div class="status-text">Disconnected</div>
        <div class="status-subtext">Trying to reconnect...</div>
      `;
    });

    window.addEventListener('beforeunload', () => {
      if (pingInterval) clearInterval(pingInterval);
      if (audioContext) audioContext.close();
    });
  </script>
</body>
</html>
